{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "https://crezia.ai/schemas/graph-dsl-v1.json",
  "title": "GraphDSL v1",
  "description": "Schema for declarative LangGraph conversation flow definitions.",
  "type": "object",
  "required": ["graph", "stateContractRef", "nodes", "transitions"],
  "additionalProperties": false,
  "properties": {
    "graph": {
      "type": "object",
      "required": ["graphId", "version", "entrypoint"],
      "additionalProperties": false,
      "properties": {
        "graphId": { "type": "string", "minLength": 1 },
        "version": { "type": "string", "minLength": 1 },
        "description": { "type": "string" },
        "entrypoint": { "type": "string", "minLength": 1, "description": "Node ID that serves as the graph entry point." },
        "tags": { "type": "array", "items": { "type": "string" }, "default": [] }
      }
    },
    "stateContractRef": {
      "type": "string",
      "minLength": 1,
      "description": "Reference to the shared Zod runtime state contract (e.g. state.CfsStateSchema)."
    },
    "nodes": {
      "type": "array",
      "minItems": 1,
      "items": {
        "type": "object",
        "required": ["id", "kind", "handlerRef"],
        "additionalProperties": false,
        "properties": {
          "id": { "type": "string", "minLength": 1, "description": "Unique node identifier in the graph." },
          "kind": {
            "type": "string",
            "enum": ["router", "question", "ingest", "compute", "integration", "terminal"],
            "description": "Semantic role of this node."
          },
          "handlerRef": { "type": "string", "minLength": 1, "description": "Registry key for the handler function." },
          "helperRefs": { "type": "array", "items": { "type": "string" }, "default": [] },
          "reads": { "type": "array", "items": { "type": "string" }, "default": [], "description": "State paths this node reads." },
          "writes": { "type": "array", "items": { "type": "string" }, "default": [], "description": "State paths this node writes." },
          "description": { "type": "string" }
        }
      }
    },
    "transitions": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "static": {
          "type": "array",
          "default": [],
          "items": {
            "type": "object",
            "required": ["from", "to"],
            "additionalProperties": false,
            "properties": {
              "from": { "type": "string", "minLength": 1 },
              "to": { "type": "string", "minLength": 1, "description": "Target node ID or __end__ for graph termination." }
            }
          }
        },
        "conditional": {
          "type": "array",
          "default": [],
          "items": {
            "type": "object",
            "required": ["from", "routerRef", "destinations"],
            "additionalProperties": false,
            "properties": {
              "from": { "type": "string", "minLength": 1 },
              "routerRef": { "type": "string", "minLength": 1, "description": "Registry key for the router function." },
              "destinations": {
                "type": "object",
                "additionalProperties": { "type": "string" },
                "description": "Map of router return values to target node IDs (use __end__ for termination)."
              }
            }
          }
        }
      }
    },
    "routingKeys": {
      "type": "array",
      "items": { "type": "string" },
      "default": [],
      "description": "State paths that drive routing decisions (documentation and compile-time validation)."
    },
    "runtimeConfigRefs": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "initConfigRef": { "type": "string", "description": "Registry key for the config initialization function." },
        "modelAliases": { "type": "object", "additionalProperties": { "type": "string" }, "default": {} },
        "messagePolicyRef": { "type": "string" },
        "promptSetRef": { "type": "string" },
        "deliveryPolicyRef": { "type": "string" },
        "exampleGeneratorRef": { "type": "string", "description": "Registry key for the example generator function." },
        "overlayPrefixRef": { "type": "string", "description": "Registry key for the overlay prefix function." }
      }
    },
    "config": {
      "type": "object",
      "additionalProperties": false,
      "description": "Per-graph conversation configuration: prompts, models, policies, question templates.",
      "properties": {
        "steps": {
          "type": "array",
          "default": [],
          "items": {
            "type": "object",
            "required": ["id", "label"],
            "additionalProperties": false,
            "properties": {
              "id": { "type": "string", "minLength": 1 },
              "label": { "type": "string", "minLength": 1 }
            }
          }
        },
        "models": {
          "type": "object",
          "default": {},
          "additionalProperties": {
            "type": "object",
            "required": ["model"],
            "additionalProperties": false,
            "properties": {
              "model": { "type": "string", "minLength": 1 },
              "temperature": { "type": "number", "minimum": 0, "maximum": 2, "default": 0.4 },
              "maxRetries": { "type": "integer", "minimum": 0, "default": 1 }
            }
          }
        },
        "messagePolicy": {
          "type": "object",
          "default": {},
          "additionalProperties": {
            "type": "object",
            "additionalProperties": false,
            "properties": {
              "allowAIRephrase": { "type": "boolean", "default": false },
              "forbidFirstPerson": { "type": "boolean", "default": false }
            }
          }
        },
        "aiPrompts": {
          "type": "object",
          "default": {},
          "additionalProperties": { "type": "string" },
          "description": "Named AI prompt templates used by node handlers."
        },
        "questionTemplates": {
          "type": "array",
          "default": [],
          "items": {
            "type": "object",
            "required": ["key", "question"],
            "additionalProperties": false,
            "properties": {
              "key": { "type": "string", "minLength": 1 },
              "question": { "type": "string", "minLength": 1 }
            }
          }
        },
        "clarifierRetryText": {
          "type": "object",
          "default": {},
          "additionalProperties": { "type": "string" },
          "description": "Retry prompt text keyed by step/question identifier."
        },
        "clarificationAcknowledgement": {
          "oneOf": [
            { "type": "string" },
            { "type": "array", "items": { "type": "string" } }
          ],
          "default": [],
          "description": "Acknowledgement phrases used before clarification replies."
        },
        "readoutVoice": {
          "type": "object",
          "additionalProperties": false,
          "properties": {
            "rolePerspective": { "type": "string", "default": "Coach_Affirmative" },
            "voiceCharacteristics": { "type": "string", "default": "" },
            "behavioralIntent": { "type": "string", "default": "" }
          }
        },
        "delivery": {
          "type": "object",
          "additionalProperties": false,
          "properties": {
            "outputTargets": {
              "type": "array",
              "items": { "type": "string", "enum": ["download", "email", "database"] },
              "default": ["download"]
            },
            "defaultOutputTargets": {
              "type": "array",
              "items": { "type": "string", "enum": ["download", "email", "database"] },
              "default": ["download"]
            },
            "allowMultiTarget": { "type": "boolean", "default": true },
            "overridesByTenant": {
              "type": "object",
              "default": {},
              "additionalProperties": {
                "type": "array",
                "items": { "type": "string", "enum": ["download", "email", "database"] }
              }
            }
          }
        }
      }
    },
    "validation": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "requiredStateFields": { "type": "array", "items": { "type": "string" }, "default": [] },
        "invariants": { "type": "array", "items": { "type": "string" }, "default": [] }
      }
    }
  }
}
